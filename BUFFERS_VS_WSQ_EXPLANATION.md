# _buffers å’Œ _wsq çš„å…³ç³»è¯¦è§£

## ğŸ“‹ æ ¸å¿ƒæ¦‚å¿µ

### 1. ä¸¤ç§é˜Ÿåˆ—çš„å®šä¹‰

#### Worker::_wsq (Work-Stealing Queue)
- **ç±»å‹**: `BoundedTaskQueue<Node*>` - **æœ‰ç•Œé˜Ÿåˆ—**
- **æ‰€æœ‰æƒ**: æ¯ä¸ªå·¥ä½œçº¿ç¨‹ç‹¬å 
- **å®¹é‡**: å›ºå®šå¤§å°ï¼ˆé»˜è®¤ 1024ï¼Œç”± `TF_DEFAULT_BOUNDED_TASK_QUEUE_LOG_SIZE` å†³å®šï¼‰
- **ç‰¹æ€§**: æ— é”çš„ Chase-Lev å·¥ä½œçªƒå–é˜Ÿåˆ—

#### Executor::_buffers (Centralized Buffers)
- **ç±»å‹**: `Freelist<Node*>` - **æ— ç•Œé˜Ÿåˆ—é›†åˆ**
- **æ‰€æœ‰æƒ**: æ‰€æœ‰çº¿ç¨‹å…±äº«
- **å®¹é‡**: æ— é™ï¼ˆåŠ¨æ€æ‰©å±•ï¼‰
- **ç»“æ„**: å¤šä¸ªæ¡¶ï¼ˆbucketï¼‰ï¼Œæ¯ä¸ªæ¡¶åŒ…å«ä¸€ä¸ª `UnboundedTaskQueue` å’Œä¸€ä¸ªäº’æ–¥é”
- **æ¡¶æ•°é‡**: `floor(log2(N))`ï¼Œå…¶ä¸­ N æ˜¯å·¥ä½œçº¿ç¨‹æ•°

---

## ğŸ¯ ä»»åŠ¡åˆ†é…ç­–ç•¥

### æ ¸å¿ƒåŸåˆ™ï¼š**è°è°ƒåº¦ï¼Œå¾€å“ªæ”¾**

```cpp
// æƒ…å†µ 1ï¼šå·¥ä½œçº¿ç¨‹è°ƒåº¦ä»»åŠ¡
void Executor::_schedule(Worker& worker, Node* node) {
    if(worker._executor == this) {
        // è°ƒç”¨è€…æ˜¯æœ¬æ‰§è¡Œå™¨çš„å·¥ä½œçº¿ç¨‹
        worker._wsq.push(node, [&](){ _buffers.push(node); });
        //                      â†‘
        //                      æº¢å‡ºå›è°ƒï¼šé˜Ÿåˆ—æ»¡æ—¶è°ƒç”¨
        _notifier.notify_one();
        return;
    }
    
    // è°ƒç”¨è€…ä¸æ˜¯æœ¬æ‰§è¡Œå™¨çš„å·¥ä½œçº¿ç¨‹ï¼ˆå¤–éƒ¨çº¿ç¨‹ï¼‰
    _buffers.push(node);
    _notifier.notify_one();
}

// æƒ…å†µ 2ï¼šå¤–éƒ¨çº¿ç¨‹è°ƒåº¦ä»»åŠ¡
void Executor::_schedule(Node* node) {
    // ç›´æ¥æ”¾å…¥ä¸­å¿ƒåŒ–ç¼“å†²åŒº
    _buffers.push(node);
    _notifier.notify_one();
}
```

---

## ğŸ“Š è¯¦ç»†åˆ†é…è§„åˆ™

### è§„åˆ™ 1ï¼šå·¥ä½œçº¿ç¨‹è°ƒåº¦ â†’ ä¼˜å…ˆæ”¾å…¥è‡ªå·±çš„ _wsq

**åœºæ™¯**ï¼šWorker 0 åœ¨æ‰§è¡Œä»»åŠ¡æ—¶äº§ç”Ÿäº†æ–°ä»»åŠ¡

```cpp
worker._wsq.push(node, [&](){ _buffers.push(node); });
```

**æµç¨‹**ï¼š
1. å°è¯•å°†ä»»åŠ¡æ”¾å…¥ Worker 0 çš„æœ¬åœ°é˜Ÿåˆ— `_wsq`
2. å¦‚æœé˜Ÿåˆ—æœªæ»¡ â†’ æˆåŠŸæ”¾å…¥ï¼Œç»“æŸ
3. å¦‚æœé˜Ÿåˆ—å·²æ»¡ â†’ è°ƒç”¨æº¢å‡ºå›è°ƒ `_buffers.push(node)`

**ä¼˜åŠ¿**ï¼š
- âœ… æ— é”æ“ä½œï¼ˆåªæœ‰æ‰€æœ‰è€…çº¿ç¨‹ pushï¼‰
- âœ… ç¼“å­˜å‹å¥½ï¼ˆä»»åŠ¡å¾ˆå¯èƒ½è¢«åŒä¸€çº¿ç¨‹æ‰§è¡Œï¼‰
- âœ… å‡å°‘ç«äº‰ï¼ˆé¿å…è®¿é—®å…±äº«çš„ _buffersï¼‰

---

### è§„åˆ™ 2ï¼šå¤–éƒ¨çº¿ç¨‹è°ƒåº¦ â†’ ç›´æ¥æ”¾å…¥ _buffers

**åœºæ™¯**ï¼šç”¨æˆ·ä¸»çº¿ç¨‹è°ƒç”¨ `executor.run(taskflow)`

```cpp
_buffers.push(node);
```

**åŸå› **ï¼š
- å¤–éƒ¨çº¿ç¨‹æ²¡æœ‰è‡ªå·±çš„ `_wsq`
- æ— æ³•åˆ¤æ–­åº”è¯¥æ”¾å…¥å“ªä¸ªå·¥ä½œçº¿ç¨‹çš„é˜Ÿåˆ—
- æ”¾å…¥ä¸­å¿ƒåŒ–ç¼“å†²åŒºï¼Œè®©å·¥ä½œçº¿ç¨‹è‡ªå·±çªƒå–

---

### è§„åˆ™ 3ï¼š_wsq æ»¡æ—¶ â†’ æº¢å‡ºåˆ° _buffers

**å…³é”®ä»£ç **ï¼š`BoundedTaskQueue::push()` çš„å®ç°

```cpp
template <typename O, typename C>
void BoundedTaskQueue<T, LogSize>::push(O&& o, C&& on_full) {
    int64_t b = _bottom.load(std::memory_order_relaxed);
    int64_t t = _top.load(std::memory_order_acquire);
    
    // æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦å·²æ»¡
    if TF_UNLIKELY((b - t) > BufferSize - 1) {
        on_full();  // è°ƒç”¨æº¢å‡ºå›è°ƒ
        return;
    }
    
    // é˜Ÿåˆ—æœªæ»¡ï¼Œæ­£å¸¸æ’å…¥
    _buffer[b & BufferMask].store(std::forward<O>(o), std::memory_order_relaxed);
    std::atomic_thread_fence(std::memory_order_release);
    _bottom.store(b + 1, std::memory_order_release);
}
```

**ç¤ºä¾‹**ï¼š
```
Worker 0 çš„ _wsq çŠ¶æ€ï¼š
[Task 1] [Task 2] ... [Task 1023] [Task 1024]  â† å·²æ»¡ï¼ˆ1024 ä¸ªä»»åŠ¡ï¼‰

å°è¯• push Task 1025ï¼š
1. æ£€æµ‹åˆ°é˜Ÿåˆ—å·²æ»¡
2. è°ƒç”¨ on_full() â†’ _buffers.push(Task 1025)
3. Task 1025 è¢«æ”¾å…¥ä¸­å¿ƒåŒ–ç¼“å†²åŒº
```

---

## ğŸ”„ å®Œæ•´çš„ä»»åŠ¡æµè½¬ç¤ºä¾‹

### åœºæ™¯ï¼š4 ä¸ªå·¥ä½œçº¿ç¨‹çš„æ‰§è¡Œå™¨

```
åˆå§‹çŠ¶æ€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Worker 0   â”‚  â”‚  Worker 1   â”‚  â”‚  Worker 2   â”‚  â”‚  Worker 3   â”‚
â”‚  _wsq: ç©º   â”‚  â”‚  _wsq: ç©º   â”‚  â”‚  _wsq: ç©º   â”‚  â”‚  _wsq: ç©º   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   _buffers      â”‚
                    â”‚  Bucket 0: ç©º   â”‚
                    â”‚  Bucket 1: ç©º   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ­¥éª¤ 1ï¼šå¤–éƒ¨çº¿ç¨‹æäº¤ä»»åŠ¡

```cpp
// ç”¨æˆ·ä¸»çº¿ç¨‹
executor.run(taskflow);  // åŒ…å« Task A, B, C
```

**ç»“æœ**ï¼š
```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   _buffers      â”‚
                    â”‚  Bucket 0: [A]  â”‚
                    â”‚  Bucket 1: [B,C]â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
æ‰€æœ‰ä»»åŠ¡éƒ½è¿›å…¥ `_buffers`ï¼ˆå› ä¸ºä¸»çº¿ç¨‹ä¸æ˜¯å·¥ä½œçº¿ç¨‹ï¼‰

---

### æ­¥éª¤ 2ï¼šWorker 0 çªƒå–å¹¶æ‰§è¡Œ Task A

```cpp
// Worker 0 ä» _buffers çªƒå–åˆ° Task A
t = _buffers.steal(0);  // ä» Bucket 0 çªƒå–

// æ‰§è¡Œ Task Aï¼ŒTask A äº§ç”Ÿäº† Task D, E, F
_schedule(worker0, Task_D);
_schedule(worker0, Task_E);
_schedule(worker0, Task_F);
```

**ç»“æœ**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Worker 0   â”‚
â”‚  _wsq:      â”‚
â”‚  [D][E][F]  â”‚  â† æ”¾å…¥ Worker 0 çš„æœ¬åœ°é˜Ÿåˆ—
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   _buffers      â”‚
                    â”‚  Bucket 0: ç©º   â”‚
                    â”‚  Bucket 1: [B,C]â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### æ­¥éª¤ 3ï¼šWorker 0 çš„é˜Ÿåˆ—æ»¡äº†

```cpp
// Worker 0 ç»§ç»­æ‰§è¡Œä»»åŠ¡ï¼Œäº§ç”Ÿæ›´å¤šä»»åŠ¡
// å‡è®¾ _wsq å·²ç»æœ‰ 1024 ä¸ªä»»åŠ¡

_schedule(worker0, Task_X);  // ç¬¬ 1025 ä¸ªä»»åŠ¡
```

**æ‰§è¡Œæµç¨‹**ï¼š
```cpp
worker0._wsq.push(Task_X, [&](){ _buffers.push(Task_X); });
                          â†“
                    é˜Ÿåˆ—å·²æ»¡ï¼Œè°ƒç”¨å›è°ƒ
                          â†“
                    _buffers.push(Task_X)
```

**ç»“æœ**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Worker 0   â”‚
â”‚  _wsq: æ»¡   â”‚
â”‚  [1024ä¸ªä»»åŠ¡]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   _buffers      â”‚
                    â”‚  Bucket 0: [X]  â”‚  â† Task X æº¢å‡ºåˆ°è¿™é‡Œ
                    â”‚  Bucket 1: [B,C]â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### æ­¥éª¤ 4ï¼šWorker 1 çªƒå–ä»»åŠ¡

```cpp
// Worker 1 çš„æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºï¼Œå¼€å§‹çªƒå–
// å…ˆå°è¯•ä»å…¶ä»– Worker çš„ _wsq çªƒå–
t = worker0._wsq.steal();  // ä» Worker 0 çš„é˜Ÿåˆ—é¡¶éƒ¨çªƒå–

// å¦‚æœ Worker 0 çš„é˜Ÿåˆ—ä¹Ÿç©ºäº†ï¼Œä» _buffers çªƒå–
t = _buffers.steal(1);  // ä» Bucket 1 çªƒå–åˆ° Task B
```

---

## ğŸ¨ æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Executor                              â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Worker 0 â”‚  â”‚ Worker 1 â”‚  â”‚ Worker 2 â”‚  â”‚ Worker 3 â”‚   â”‚
â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚   â”‚
â”‚  â”‚  _wsq    â”‚  â”‚  _wsq    â”‚  â”‚  _wsq    â”‚  â”‚  _wsq    â”‚   â”‚
â”‚  â”‚ (æœ‰ç•Œ)   â”‚  â”‚ (æœ‰ç•Œ)   â”‚  â”‚ (æœ‰ç•Œ)   â”‚  â”‚ (æœ‰ç•Œ)   â”‚   â”‚
â”‚  â”‚ 1024     â”‚  â”‚ 1024     â”‚  â”‚ 1024     â”‚  â”‚ 1024     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚             â”‚             â”‚             â”‚          â”‚
â”‚       â”‚ æº¢å‡º        â”‚ æº¢å‡º        â”‚ æº¢å‡º        â”‚ æº¢å‡º     â”‚
â”‚       â†“             â†“             â†“             â†“          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              _buffers (Freelist)                   â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚   â”‚
â”‚  â”‚  â”‚ Bucket 0 â”‚  â”‚ Bucket 1 â”‚  ...                  â”‚   â”‚
â”‚  â”‚  â”‚ (æ— ç•Œ)   â”‚  â”‚ (æ— ç•Œ)   â”‚                       â”‚   â”‚
â”‚  â”‚  â”‚ + mutex  â”‚  â”‚ + mutex  â”‚                       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â†‘                                  â”‚
â”‚                         â”‚                                  â”‚
â”‚                    å¤–éƒ¨çº¿ç¨‹ç›´æ¥æ”¾å…¥                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### _wsq (æœ¬åœ°é˜Ÿåˆ—) çš„ä¼˜åŠ¿

| ç‰¹æ€§ | _wsq | _buffers |
|------|------|----------|
| **å¹¶å‘æ§åˆ¶** | æ— é”ï¼ˆæ‰€æœ‰è€… push/popï¼‰ | æœ‰é”ï¼ˆæ¯ä¸ªæ¡¶ä¸€ä¸ª mutexï¼‰ |
| **ç¼“å­˜å±€éƒ¨æ€§** | é«˜ï¼ˆä»»åŠ¡åœ¨åŒä¸€çº¿ç¨‹æ‰§è¡Œï¼‰ | ä½ï¼ˆä»»åŠ¡å¯èƒ½è¢«ä»»ä½•çº¿ç¨‹çªƒå–ï¼‰ |
| **ç«äº‰ç¨‹åº¦** | ä½ï¼ˆåªæœ‰çªƒå–æ—¶ç«äº‰ï¼‰ | é«˜ï¼ˆå¤šçº¿ç¨‹å…±äº«ï¼‰ |
| **å®¹é‡** | æœ‰ç•Œï¼ˆ1024ï¼‰ | æ— ç•Œï¼ˆåŠ¨æ€æ‰©å±•ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | å·¥ä½œçº¿ç¨‹äº§ç”Ÿçš„ä»»åŠ¡ | å¤–éƒ¨çº¿ç¨‹æäº¤çš„ä»»åŠ¡ |

### ä¸ºä»€ä¹ˆä¼˜å…ˆä½¿ç”¨ _wsqï¼Ÿ

1. **æ— é”æ€§èƒ½**
   ```cpp
   // _wsq.push() - æ— é”
   _buffer[b & BufferMask].store(node, std::memory_order_relaxed);
   _bottom.store(b + 1, std::memory_order_release);
   ```

2. **ç¼“å­˜å‹å¥½**
   ```
   Worker 0 äº§ç”Ÿ Task A â†’ æ”¾å…¥ Worker 0 çš„ _wsq
                       â†’ Worker 0 å¾ˆå¯èƒ½ç«‹å³æ‰§è¡Œ Task A
                       â†’ CPU ç¼“å­˜å‘½ä¸­ç‡é«˜
   ```

3. **å‡å°‘ç«äº‰**
   ```
   4 ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œæ¯ä¸ªæœ‰è‡ªå·±çš„ _wsq
   â†’ 4 ä¸ªç‹¬ç«‹çš„é˜Ÿåˆ—ï¼Œäº’ä¸å¹²æ‰°

   å¦‚æœéƒ½ç”¨ _buffersï¼š
   â†’ åªæœ‰ 2 ä¸ªæ¡¶ï¼ˆfloor(log2(4)) = 2ï¼‰
   â†’ 4 ä¸ªçº¿ç¨‹ç«äº‰ 2 ä¸ªæ¡¶
   â†’ é”ç«äº‰å¢åŠ 
   ```

---

## ğŸ” _buffers çš„è®¾è®¡ç»†èŠ‚

### å¤šæ¡¶è®¾è®¡

```cpp
// Freelist æ„é€ å‡½æ•°
Freelist(size_t N) :
    _buckets(N < SIZE_LUT.size() ? SIZE_LUT[N] : floor_log2(N)) {
}
```

**æ¡¶æ•°é‡è®¡ç®—**ï¼š
```
1 ä¸ªå·¥ä½œçº¿ç¨‹  â†’ 1 ä¸ªæ¡¶
2-3 ä¸ªçº¿ç¨‹    â†’ 1 ä¸ªæ¡¶
4-7 ä¸ªçº¿ç¨‹    â†’ 2 ä¸ªæ¡¶
8-15 ä¸ªçº¿ç¨‹   â†’ 3 ä¸ªæ¡¶
16-31 ä¸ªçº¿ç¨‹  â†’ 4 ä¸ªæ¡¶
...
```

### å“ˆå¸Œåˆ†é…ç­–ç•¥

```cpp
void Freelist::push(T item) {
    // ä½¿ç”¨æŒ‡é’ˆåœ°å€çš„é«˜ä½è¿›è¡Œå“ˆå¸Œ
    auto b = (reinterpret_cast<uintptr_t>(item) >> 16) % _buckets.size();
    std::scoped_lock lock(_buckets[b].mutex);
    _buckets[b].queue.push(item);
}
```

**ä¸ºä»€ä¹ˆå³ç§» 16 ä½ï¼Ÿ**
- æŒ‡é’ˆåœ°å€é€šå¸¸ 8 å­—èŠ‚å¯¹é½ï¼ˆä½ 3 ä½ä¸º 0ï¼‰
- å³ç§» 16 ä½å¯ä»¥åˆ©ç”¨åœ°å€çš„ä¸­é«˜ä½
- é¿å…ç›¸é‚»åœ°å€çš„ä»»åŠ¡éƒ½å“ˆå¸Œåˆ°åŒä¸€ä¸ªæ¡¶

**ç¤ºä¾‹**ï¼š
```
Task A åœ°å€: 0x7fff12340000  â†’ å“ˆå¸Œåˆ° Bucket 0
Task B åœ°å€: 0x7fff12340010  â†’ å“ˆå¸Œåˆ° Bucket 0 (ç›¸é‚»)
Task C åœ°å€: 0x7fff56780000  â†’ å“ˆå¸Œåˆ° Bucket 1 (ä¸åŒåŒºåŸŸ)
```

---

## ğŸš€ å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šå¯†é›†è®¡ç®—ä»»åŠ¡

```cpp
tf::Taskflow taskflow;
tf::Task A = taskflow.emplace([&](){
    // äº§ç”Ÿå¤§é‡å­ä»»åŠ¡
    for(int i = 0; i < 10000; i++) {
        // è¿™äº›ä»»åŠ¡ä¼šæ”¾å…¥å½“å‰ Worker çš„ _wsq
        // å¦‚æœ _wsq æ»¡äº†ï¼Œæº¢å‡ºåˆ° _buffers
    }
});
```

**ä»»åŠ¡åˆ†å¸ƒ**ï¼š
- å‰ 1024 ä¸ªå­ä»»åŠ¡ â†’ Worker çš„ _wsq
- å 8976 ä¸ªå­ä»»åŠ¡ â†’ _buffersï¼ˆæº¢å‡ºï¼‰

---

### åœºæ™¯ 2ï¼šå¤–éƒ¨çº¿ç¨‹æäº¤

```cpp
// ä¸»çº¿ç¨‹
std::thread t1([&](){
    executor.run(taskflow1);  // æ‰€æœ‰ä»»åŠ¡ â†’ _buffers
});

std::thread t2([&](){
    executor.run(taskflow2);  // æ‰€æœ‰ä»»åŠ¡ â†’ _buffers
});
```

**åŸå› **ï¼št1 å’Œ t2 ä¸æ˜¯æ‰§è¡Œå™¨çš„å·¥ä½œçº¿ç¨‹

---

### åœºæ™¯ 3ï¼šå¼‚æ­¥ä»»åŠ¡

```cpp
// ä»ä»»ä½•çº¿ç¨‹è°ƒç”¨
executor.async([](){
    std::cout << "Async task\n";
});
```

**æµç¨‹**ï¼š
```cpp
// å†…éƒ¨å®ç°
void Executor::_schedule_async_task(Node* node) {
    _buffers.push(node);  // ç›´æ¥æ”¾å…¥ _buffers
    _notifier.notify_one();
}
```

---

## ğŸ¯ å…³é”®è¦ç‚¹æ€»ç»“

### 1. ä»»åŠ¡æ”¾å…¥ _wsq çš„æ¡ä»¶

âœ… **å¿…é¡»åŒæ—¶æ»¡è¶³**ï¼š
1. è°ƒç”¨è€…æ˜¯æœ¬æ‰§è¡Œå™¨çš„å·¥ä½œçº¿ç¨‹ï¼ˆ`worker._executor == this`ï¼‰
2. _wsq æœªæ»¡ï¼ˆå®¹é‡ < 1024ï¼‰

### 2. ä»»åŠ¡æ”¾å…¥ _buffers çš„æƒ…å†µ

ä»¥ä¸‹**ä»»ä¸€**æƒ…å†µä¼šæ”¾å…¥ _buffersï¼š
1. âŒ è°ƒç”¨è€…ä¸æ˜¯å·¥ä½œçº¿ç¨‹ï¼ˆå¤–éƒ¨çº¿ç¨‹ï¼‰
2. âŒ è°ƒç”¨è€…æ˜¯å…¶ä»–æ‰§è¡Œå™¨çš„å·¥ä½œçº¿ç¨‹
3. âŒ å·¥ä½œçº¿ç¨‹çš„ _wsq å·²æ»¡ï¼ˆæº¢å‡ºï¼‰

### 3. çªƒå–ä¼˜å…ˆçº§

å·¥ä½œçº¿ç¨‹çªƒå–ä»»åŠ¡çš„é¡ºåºï¼š
```
1. è‡ªå·±çš„ _wsq.pop()        (æœ€ä¼˜å…ˆï¼ŒLIFO)
2. å…¶ä»– Worker çš„ _wsq.steal()  (éšæœºé€‰æ‹©ï¼ŒFIFO)
3. _buffers.steal()         (æœ€åé€‰æ‹©)
```

### 4. è®¾è®¡å“²å­¦

```
æœ¬åœ°ä¼˜å…ˆï¼ˆLocal Firstï¼‰ï¼š
  å°½é‡ä½¿ç”¨æœ¬åœ°é˜Ÿåˆ— _wsq
  â†’ æ— é”ã€ç¼“å­˜å‹å¥½ã€ä½ç«äº‰

å…¨å±€å…œåº•ï¼ˆGlobal Fallbackï¼‰ï¼š
  _buffers ä½œä¸ºå¤‡ç”¨
  â†’ å¤„ç†æº¢å‡ºã€å¤–éƒ¨æäº¤ã€è´Ÿè½½å‡è¡¡
```

---

## ğŸ“š ç›¸å…³ä»£ç ä½ç½®

- **_wsq å®ç°**: `taskflow/core/tsq.hpp` (BoundedTaskQueue)
- **_buffers å®ç°**: `taskflow/core/freelist.hpp` (Freelist)
- **è°ƒåº¦é€»è¾‘**: `taskflow/core/executor.hpp` (_schedule æ–¹æ³•)
- **çªƒå–é€»è¾‘**: `taskflow/core/executor.hpp` (_explore_task æ–¹æ³•)

---

## ğŸ”¬ æ·±å…¥ç†è§£ï¼šä¸ºä»€ä¹ˆéœ€è¦ä¸¤å±‚é˜Ÿåˆ—ï¼Ÿ

### å•å±‚è®¾è®¡çš„é—®é¢˜

å¦‚æœåªç”¨ _buffersï¼ˆå…±äº«é˜Ÿåˆ—ï¼‰ï¼š
```
âŒ æ‰€æœ‰ä»»åŠ¡éƒ½éœ€è¦åŠ é”
âŒ ç¼“å­˜å±€éƒ¨æ€§å·®
âŒ é”ç«äº‰ä¸¥é‡
âŒ æ€§èƒ½ä¸‹é™
```

å¦‚æœåªç”¨ _wsqï¼ˆæœ¬åœ°é˜Ÿåˆ—ï¼‰ï¼š
```
âŒ å¤–éƒ¨çº¿ç¨‹æ— æ³•æäº¤ä»»åŠ¡
âŒ é˜Ÿåˆ—æ»¡æ—¶æ— æ³•å¤„ç†
âŒ è´Ÿè½½ä¸å‡è¡¡
```

### ä¸¤å±‚è®¾è®¡çš„ä¼˜åŠ¿

```
_wsq (æœ¬åœ°é˜Ÿåˆ—)ï¼š
  âœ… å¿«é€Ÿè·¯å¾„ï¼ˆFast Pathï¼‰
  âœ… æ— é”ã€é«˜æ€§èƒ½
  âœ… å¤„ç† 99% çš„å¸¸è§æƒ…å†µ

_buffers (å…±äº«é˜Ÿåˆ—)ï¼š
  âœ… æ…¢é€Ÿè·¯å¾„ï¼ˆSlow Pathï¼‰
  âœ… å¤„ç†ç‰¹æ®Šæƒ…å†µ
  âœ… ä¿è¯ç³»ç»Ÿçš„å®Œæ•´æ€§å’Œçµæ´»æ€§
```

è¿™å°±æ˜¯ Taskflow é«˜æ€§èƒ½çš„ç§˜å¯†ä¹‹ä¸€ï¼ğŸ‰


